<!DOCTYPE html>
<html prefix="
og: http://ogp.me/ns#
article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width">
<title>using-pipelines-for-multiple-preprocessing-steps | 绿萝间</title>
<link href="../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<link rel="alternate" type="application/rss+xml" title="RSS" href="../rss.xml">
<link rel="canonical" href="http://muxuezi.github.io/posts/using-pipelines-for-multiple-preprocessing-steps.html">
<script type="text/javascript">
MathJax.Hub.Config({
    tex2jax: {
         inlineMath: [ ['$','$'], ["\\(","\\)"] ],
         displayMath: [ ['$$','$$'], ["\\[","\\]"] ]
             },
         displayAlign: 'center', // Change this to 'center' to center equations.
         "HTML-CSS": {
             styles: {'.MathJax_Display': {"margin": 0}}
     }
});
</script><script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_HTML"></script><!--[if lt IE 9]><script src="/assets/js/html5.js"></script><![endif]--><meta name="author" content="tj2">
<meta property="og:site_name" content="绿萝间">
<meta property="og:title" content="using-pipelines-for-multiple-preprocessing-steps">
<meta property="og:url" content="http://muxuezi.github.io/posts/using-pipelines-for-multiple-preprocessing-steps.html">
<meta property="og:description" content="用管线命令处理多个步骤¶








管线命令不经常用，但是很有用。它们可以把多个步骤组合成一个对象执行。这样可以更方便灵活地调节和控制整个模型的配置，而不只是一个一个步骤调节。









Getting ready¶








这是我们把多个数据处理步骤组合成一个对象的第一部分。在scikit-learn里称为pipeline。这里我们首先通过计算处理缺失值；然后将数据集调整为">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2015-07-27T14:58:57+08:00">
<meta property="article:tag" content="CHS">
<meta property="article:tag" content="ipython">
<meta property="article:tag" content="Machine Learning">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="scikit-learn cookbook">
</head>
<body>
    <section class="social"><ul>
<li><a href="../index.html" title="Home"><i class="icon-home"></i></a></li>
            <li><a href="../archive.html" title="Archives"><i class="icon-folder-open-alt"></i></a></li>
            <li><a href="../categories/index.html" title="Tags"><i class="icon-tags"></i></a></li>
            <li><a href="../rss.xml" title="RSS"><i class="icon-rss"></i></a></li>
            <li><a href="https://twitter.com/muxuezi" title="My Twitter"><i class="icon-twitter"></i></a></li>
            <li><a href="https://github.com/muxuezi" title="My Github"><i class="icon-github"></i></a></li>

        </ul></section><section class="page-content"><div class="content" rel="main">
    <div class="post">
        <h1 class="p-name entry-title" itemprop="headline name">using-pipelines-for-multiple-preprocessing-steps</h1>

        <div class="meta">
            <div class="authordate">
                <time class="timeago" datetime="2015-07-27T14:58:57+08:00">2015-07-27 14:58</time>
            
                      |  
        <a href="using-pipelines-for-multiple-preprocessing-steps.ipynb" id="sourcelink">Source</a>
          |  
        <a href="javascript:%24.getScript(%22/assets/js/miniPageNav.js%22);">Minimap</a>

            </div>
                    <div itemprop="keywords" class="tags">
        <ul>
        Tags : 
           <li><a class="tag p-category" href="../categories/chs.html" rel="tag">CHS</a></li>
           <li><a class="tag p-category" href="../categories/ipython.html" rel="tag">ipython</a></li>
           <li><a class="tag p-category" href="../categories/machine-learning.html" rel="tag">Machine Learning</a></li>
           <li><a class="tag p-category" href="../categories/python.html" rel="tag">Python</a></li>
           <li><a class="tag p-category" href="../categories/scikit-learn-cookbook.html" rel="tag">scikit-learn cookbook</a></li>
        </ul>
</div>

        </div>
        <div class="body">
            <div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="用管线命令处理多个步骤">用管线命令处理多个步骤<a class="anchor-link" href="using-pipelines-for-multiple-preprocessing-steps.html#%E7%94%A8%E7%AE%A1%E7%BA%BF%E5%91%BD%E4%BB%A4%E5%A4%84%E7%90%86%E5%A4%9A%E4%B8%AA%E6%AD%A5%E9%AA%A4">¶</a>
</h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>管线命令不经常用，但是很有用。它们可以把多个步骤组合成一个对象执行。这样可以更方便灵活地调节和控制整个模型的配置，而不只是一个一个步骤调节。</p>
<!-- TEASER_END -->
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Getting-ready">Getting ready<a class="anchor-link" href="using-pipelines-for-multiple-preprocessing-steps.html#Getting-ready">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>这是我们把多个数据处理步骤组合成一个对象的第一部分。在scikit-learn里称为<code>pipeline</code>。这里我们首先通过计算处理缺失值；然后将数据集调整为均值为0，标准差为1的标准形。</p>
<p>让我们创建一个有缺失值的数据集，然后再演示<code>pipeline</code>的用法：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="How-to-do-it...">How to do it...<a class="anchor-link" href="using-pipelines-for-multiple-preprocessing-steps.html#How-to-do-it...">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>如果不用管线命令，我们可能会这样实现：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>现在我们用<code>pipeline</code>来演示：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>我们看看<code>pipe</code>的内容。和前面介绍一致，管线命令定义了处理步骤：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>然后在调用<code>pipe</code>的<code>fit_transform</code>方法，就可以把多个步骤组合成一个对象了：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>可以用Numpy验证一下结果：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>完全正确！本书后面的主题中，我们会进一步展示管线命令的威力。不仅可以用于预处理步骤中，在降维、算法拟合中也可以很方便的使用。</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="How-it-works...">How it works...<a class="anchor-link" href="using-pipelines-for-multiple-preprocessing-steps.html#How-it-works...">¶</a>
</h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>前面曾经提到过，每个scikit-learn的算法接口都类似。<code>pipeline</code>最重要的函数也不外乎下面三个：</p>
<ul>
<li><code>fit</code></li>
<li><code>transform</code></li>
<li><code>fit_transform</code></li>
</ul>
<p>具体来说，如果管线命令有<code>N</code>个对象，前<code>N-1</code>个对象必须实现<code>fit</code>和<code>transform</code>，第<code>N</code>个对象至少实现<code>fit</code>。否则就会出现错误。</p>
<p>如果这些条件满足，管线命令就会运行，但是不一定每个方法都可以。例如，<code>pipe</code>有个<code>inverse_transform</code>方法就是这样。因为由于计算步骤没有<code>inverse_transform</code>方法，一运行就有错误：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

<span class="ansired">---------------------------------------------------------------------------</span>
<span class="ansired">AttributeError</span>                            Traceback (most recent call last)
<span class="ansigreen">&lt;ipython-input-12-62edd2667cae&gt;</span> in <span class="ansicyan">&lt;module&gt;</span><span class="ansiblue">()</span>
<span class="ansigreen">----&gt; 1</span><span class="ansiyellow"> </span>pipe<span class="ansiyellow">.</span>inverse_transform<span class="ansiyellow">(</span>new_mat<span class="ansiyellow">)</span><span class="ansiyellow"></span>

<span class="ansigreen">d:\programfiles\Miniconda3\lib\site-packages\sklearn\utils\metaestimators.py</span> in <span class="ansicyan">&lt;lambda&gt;</span><span class="ansiblue">(*args, **kwargs)</span>
<span class="ansigreen">     35</span>             self<span class="ansiyellow">.</span>get_attribute<span class="ansiyellow">(</span>obj<span class="ansiyellow">)</span><span class="ansiyellow"></span>
<span class="ansigreen">     36</span>         <span class="ansired"># lambda, but not partial, allows help() to work with update_wrapper</span><span class="ansiyellow"></span><span class="ansiyellow"></span>
<span class="ansigreen">---&gt; 37</span><span class="ansiyellow">         </span>out <span class="ansiyellow">=</span> <span class="ansigreen">lambda</span> <span class="ansiyellow">*</span>args<span class="ansiyellow">,</span> <span class="ansiyellow">**</span>kwargs<span class="ansiyellow">:</span> self<span class="ansiyellow">.</span>fn<span class="ansiyellow">(</span>obj<span class="ansiyellow">,</span> <span class="ansiyellow">*</span>args<span class="ansiyellow">,</span> <span class="ansiyellow">**</span>kwargs<span class="ansiyellow">)</span><span class="ansiyellow"></span>
<span class="ansigreen">     38</span>         <span class="ansired"># update the docstring of the returned function</span><span class="ansiyellow"></span><span class="ansiyellow"></span>
<span class="ansigreen">     39</span>         update_wrapper<span class="ansiyellow">(</span>out<span class="ansiyellow">,</span> self<span class="ansiyellow">.</span>fn<span class="ansiyellow">)</span><span class="ansiyellow"></span>

<span class="ansigreen">d:\programfiles\Miniconda3\lib\site-packages\sklearn\pipeline.py</span> in <span class="ansicyan">inverse_transform</span><span class="ansiblue">(self, X)</span>
<span class="ansigreen">    265</span>         Xt <span class="ansiyellow">=</span> X<span class="ansiyellow"></span>
<span class="ansigreen">    266</span>         <span class="ansigreen">for</span> name<span class="ansiyellow">,</span> step <span class="ansigreen">in</span> self<span class="ansiyellow">.</span>steps<span class="ansiyellow">[</span><span class="ansiyellow">:</span><span class="ansiyellow">:</span><span class="ansiyellow">-</span><span class="ansicyan">1</span><span class="ansiyellow">]</span><span class="ansiyellow">:</span><span class="ansiyellow"></span>
<span class="ansigreen">--&gt; 267</span><span class="ansiyellow">             </span>Xt <span class="ansiyellow">=</span> step<span class="ansiyellow">.</span>inverse_transform<span class="ansiyellow">(</span>Xt<span class="ansiyellow">)</span><span class="ansiyellow"></span>
<span class="ansigreen">    268</span>         <span class="ansigreen">return</span> Xt<span class="ansiyellow"></span>
<span class="ansigreen">    269</span> <span class="ansiyellow"></span>

<span class="ansired">AttributeError</span>: 'Imputer' object has no attribute 'inverse_transform'
</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>但是，<code>scalar</code>对象可以正常运行：</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">In [ ]:</div>
<div class="inner_cell">
<div class="input_area">
<div class=" highlight hl-ipython3"><pre> 
</pre></div>

<i class="icon-hand-up icon-large" style="float:right; margin-bottom:8px; margin-right:10px">
  hide output</i>
</div>
</div>
</div>

<div class="output_wrapper output_hidden">
<div class="output">

<div class="output_wrapper">
<div class="output">


<div class="output_area">
<div class="prompt"></div>

</div>

</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>只要把管线命令设置好，它就会如愿运行。它就是一组<code>for</code>循环，对每个步骤执行<code>fit</code>和<code>transform</code>，然后把结果传递到下一个变换操作中。</p>
<p>使用管线命令的理由主要有两点：</p>
<ul>
<li>首先是方便。代码会简洁一些，不需要重复调用<code>fit</code>和<code>transform</code>。</li>
<li>其次，也是更重要的作用，就是使用交叉验证。模型可以变得很复杂。如果管线命令中的一个步骤调整了参数，那么它们必然需要重新测试；测试一个步骤参数的代码管理成本是很低的。但是，如果测试5个步骤的全部参数会变都很复杂。管线命令可以缓解这些负担。</li>
</ul>
</div>
</div>
</div>
</div>
        </div>
                <ul class="pager hidden-print">
<li class="previous">
                <a href="using-gaussian-processes-for-regression.html" rel="prev" title="using-gaussian-processes-for-regression">Previous post</a>
            </li>
            <li class="next">
                <a href="using-stochastic-gradient-descent-for-regression.html" rel="next" title="using-stochastic-gradient-descent-for-regression">Next post</a>
            </li>
        </ul>
<div id="disqus_thread"></div>
        <script>
        var disqus_shortname ="tj2",
            disqus_url="http://muxuezi.github.io/posts/using-pipelines-for-multiple-preprocessing-steps.html",
        disqus_title="using-pipelines-for-multiple-preprocessing-steps",
        disqus_identifier="cache/posts/using-pipelines-for-multiple-preprocessing-steps.html",
        disqus_config = function () {
            this.language = "en";
        };
        (function() {
            var dsq = document.createElement('script'); dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script><noscript>Please enable JavaScript to view the <a href="//disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a>
</noscript>
    <a href="//disqus.com" class="dsq-brlink" rel="nofollow">Comments powered by <span class="logo-disqus">Disqus</span></a>


                <script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$latex ','$'], ['\\(','\\)']]}});</script><script src="../assets/js/mathjax.js"></script>
</div>
                    <footer id="footer"><p>Contents © 2015         <a href="mailto:muxuezi@gmail.com">tj2</a> - Powered by         <a href="https://getnikola.com" rel="nofollow">Nikola</a>         
<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/2.5/ar/">
<img alt="Creative Commons License BY-NC-SA" style="border-width:0; margin-bottom:12px;" src="http://i.creativecommons.org/l/by-nc-sa/2.5/ar/88x31.png"></a></p>
            
        </footer>
</div>
    </section><script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-51330059-1', 'auto');
  ga('send', 'pageview');

</script><script src="../assets/js/all-nocdn.js" type="text/javascript"></script><!-- Social buttons --><div id="addthisbox" class="addthis_toolbox addthis_peekaboo_style addthis_default_style addthis_label_style addthis_32x32_style">
<a class="addthis_button_more">Share</a>
<ul>
<li>
<a class="addthis_button_facebook"></a>
</li>
<li>
<a class="addthis_button_google_plusone_share"></a>
</li>
<li>
<a class="addthis_button_linkedin"></a>
</li>
<li>
<a class="addthis_button_twitter"></a>
</li>
</ul>
</div>
<script src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-4f7088a56bb93798"></script><!-- End of social buttons --><script type="text/javascript">
            $(function(){
                $('.timeago').timeago();
            });
        </script>
</body>
</html>
